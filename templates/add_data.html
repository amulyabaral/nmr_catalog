<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Submit Resource</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <!-- Add Select2 CSS for better multi-select -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <style>
        .form-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background: #f9f9f9; /* Lighter background */
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); /* Subtle shadow */
        }
        .form-group {
            margin-bottom: 1.5rem;
        }
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600; /* Slightly bolder labels */
            color: #333;
        }
        input[type="text"],
        input[type="url"],
        input[type="number"], /* For years */
        select,
        textarea {
            width: 100%;
            padding: 0.8rem; /* Consistent padding */
            border: 1px solid #ccc; /* Slightly darker border */
            border-radius: 4px;
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            box-sizing: border-box; /* Include padding in width */
        }
        textarea {
            min-height: 120px;
            resize: vertical; /* Allow vertical resize */
        }
        select[multiple] {
            min-height: 100px; /* Give multi-selects some height */
        }
        .submit-button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.9rem 2.5rem; /* Larger button */
            border-radius: var(--border-radius);
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-block; /* Allow margin */
            margin-top: 1rem;
        }
        .submit-button:hover {
            background: #00b046;
            transform: translateY(-1px); /* Slight lift on hover */
        }
        .error-message, .success-message { /* Style flash messages */
            margin-bottom: 1rem;
            padding: 1rem;
            border-radius: 4px;
            font-weight: 500;
        }
        .error-message {
            color: #a94442;
            background-color: #f2dede;
            border: 1px solid #ebccd1;
        }
         .success-message {
            color: #3c763d;
            background-color: #dff0d8;
            border: 1px solid #d6e9c6;
        }
        .back-link {
            display: inline-block;
            margin-bottom: 1.5rem; /* More space */
            color: var(--secondary-color);
            text-decoration: none;
            font-weight: 500;
        }
        .back-link:hover {
            text-decoration: underline;
        }
        fieldset {
            border: 1px solid #ddd;
            padding: 1.5rem; /* More padding */
            border-radius: 4px;
            margin-bottom: 2rem; /* More space between sections */
            background-color: #fff; /* White background for fieldsets */
        }
        legend {
            padding: 0 0.8rem; /* More padding */
            font-weight: 600; /* Bolder legend */
            font-size: 1.1em;
            color: #555;
        }
        .year-range-selector {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .year-range-selector label {
            margin-bottom: 0;
            margin-right: 0.5rem;
            font-weight: normal;
        }
        .year-select {
            width: auto; /* Don't force full width */
            min-width: 100px;
        }
        .selected-items { /* Container for tags */
            margin-top: 0.5rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .selected-tag {
            background-color: #e0e0e0;
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
            font-size: 0.9em;
            display: flex;
            align-items: center;
        }
        .remove-tag {
            margin-left: 0.5rem;
            cursor: pointer;
            font-weight: bold;
            color: #777;
        }
        .remove-tag:hover {
            color: #333;
        }
        /* Select2 overrides */
        .select2-container .select2-selection--multiple {
            min-height: 40px; /* Match input height */
            border: 1px solid #ccc !important;
            padding: 0.3rem;
        }
        .select2-container--default .select2-selection--multiple .select2-selection__choice {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
            padding: 3px 6px;
            font-size: 0.9em;
        }
        .select2-container--default .select2-selection--multiple .select2-selection__choice__remove {
            color: rgba(255, 255, 255, 0.7);
            margin-right: 5px;
        }
        .select2-container--default .select2-selection--multiple .select2-selection__choice__remove:hover {
            color: white;
        }
        .hierarchy-select-group {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .hierarchy-select-group select {
            display: none; /* Hide by default, show via JS */
        }
        .hierarchy-select-group select.visible {
            display: block; /* Show when populated */
        }
        .related-metadata-container {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 1rem;
            background: #fff;
            border-radius: 4px;
        }
        .related-metadata-container .hierarchy-node {
            margin-left: calc(var(--level, 1) * 15px - 15px); /* Indentation */
            padding: 3px 0;
        }
        .related-metadata-container label {
            font-weight: normal;
            display: inline-flex; /* Align checkbox and text */
            align-items: center;
            cursor: pointer;
        }
         .related-metadata-container input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
        }
    </style>
</head>
<body>
    <nav class="main-nav">
        <div class="nav-container">
            <div class="logo">
                <a href="/">NoMoReAMR</a>
            </div>
            <div class="nav-links">
                <a href="/">Home</a>
                <!-- Add other relevant links -->
            </div>
        </div>
    </nav>

    <div class="form-container">
        <h1>Submit New Resource for Review</h1>
        <a href="{{ url_for('index') }}" class="back-link">‚Üê Back to Home</a>

        <!-- Flash messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div class="{{ category }}-message">{{ message }}</div>
            {% endfor %}
          {% endif %}
        {% endwith %}

        <!-- NEW AI URL Processing Form -->
        <fieldset style="background-color: #eef7ff; border-color: #b3d7ff;">
            <legend style="color: #0056b3;">AI-Powered Pre-fill (Experimental)</legend>
            <form method="POST" action="{{ url_for('ai_process_input') }}" id="ai-input-form" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="ai_url">Enter URL of the resource (webpage, PDF link):</label>
                    <input type="url" id="ai_url" name="ai_url" placeholder="https://example.com/resource-document.pdf" style="margin-bottom: 0.5rem;">
                </div>
                <div class="form-group">
                    <label for="ai_file">Or upload a file (PDF, TXT, HTML):</label>
                    <input type="file" id="ai_file" name="ai_file" accept=".pdf,.txt,.html,.htm">
                    <small>The AI will attempt to extract information from the URL or file. Processing might take a minute.</small>
                </div>
                <!-- Status and Spinner -->
                <button type="submit" name="submit_action" value="prefill" class="submit-button" style="background-color: var(--secondary-color); padding: 0.7rem 1.5rem; font-size: 1rem; margin-right: 10px;">Process & Pre-fill Form</button>
                <button type="submit" name="submit_action" value="direct_submit" class="submit-button" style="background-color: var(--primary-color); padding: 0.7rem 1.5rem; font-size: 1rem;">Process & Submit Directly</button>
                <div id="ai-status-container" style="margin-top: 1rem; display: none; text-align: center;">
                    <div class="spinner" style="margin-bottom: 0.5rem;"></div>
                    <p id="ai-status-message" style="font-style: italic; color: #555;"></p>
                </div>
            </form>
        </fieldset>
        <!-- END NEW AI URL Processing Form -->

        <form method="POST" id="add-resource-form">
            <!-- Main Categories -->
            <fieldset>
                <legend>Main Categories</legend>

                <div class="form-group">
                    <label for="countries">Countries (select one or more):</label>
                    {# Safely get selected countries, defaulting to an empty list if form_data is not a MultiDict or key is missing #}
                    {% set selected_countries = form_data.getlist('countries') | default([]) %}
                    <select id="countries" name="countries" multiple required class="multi-select-tags">
                        {% for country in vocabularies.main_categories.Country %}
                            {# Check membership against the safely retrieved list #}
                            <option value="{{ country }}" {% if country in selected_countries %}selected{% endif %}>{{ country }}</option>
                        {% endfor %}
                    </select>
                    <!-- Selected tags will be handled by Select2 -->
                </div>

                <div class="form-group">
                    <label for="domains">Domains (select one or more):</label>
                    {# Safely get selected domains #}
                    {% set selected_domains = form_data.getlist('domains') | default([]) %}
                    <select id="domains" name="domains" multiple required class="multi-select-tags">
                        {% for domain in vocabularies.main_categories.Domain %}
                             {# Check membership against the safely retrieved list #}
                            <option value="{{ domain }}" {% if domain in selected_domains %}selected{% endif %}>{{ domain }}</option>
                        {% endfor %}
                    </select>
                     <!-- Selected tags will be handled by Select2 -->
                </div>
            </fieldset>

            <!-- Primary Hierarchy Path -->
            <fieldset>
                <legend>Primary Classification</legend>
                <p>Select the single, most specific classification for this resource.</p>
                <div class="form-group hierarchy-select-group">
                    <label for="level1_resource_type">Level 1: Resource Type</label>
                    <select id="level1_resource_type" name="level1_resource_type" required class="hierarchy-select visible" data-level="1">
                        <option value="" disabled selected>-- Select Resource Type --</option>
                        {% for type_key, type_details in vocabularies.resource_type_hierarchy.items() %}
                            <option value="{{ type_key }}" {% if type_key == form_data.get('level1_resource_type') %}selected{% endif %}>
                                {{ type_details.get('title', type_key.replace('_', ' ').title()) }}
                            </option>
                        {% endfor %}
                    </select>

                    <label for="level2_category">Level 2: Category</label>
                    <select id="level2_category" name="level2_category" class="hierarchy-select" data-level="2">
                        <option value="" disabled selected>-- Select Category --</option>
                    </select>

                    <label for="level3_subcategory">Level 3: Subcategory</label>
                    <select id="level3_subcategory" name="level3_subcategory" class="hierarchy-select" data-level="3">
                        <option value="" disabled selected>-- Select Subcategory --</option>
                    </select>

                    <label for="level4_data_type">Level 4: Data Type / Item</label>
                    <select id="level4_data_type" name="level4_data_type" class="hierarchy-select" data-level="4">
                        <option value="" disabled selected>-- Select Data Type / Item --</option>
                    </select>

                    <label for="level5_item">Level 5: Item / Detail</label>
                    <select id="level5_item" name="level5_item" class="hierarchy-select" data-level="5">
                        <option value="" disabled selected>-- Select Item / Detail --</option>
                    </select>
                </div>
            </fieldset>

            <!-- Resource Details -->
            <fieldset>
                <legend>Resource Details</legend>

                <div class="form-group">
                    <label for="resource_name">Resource Name / Title:</label>
                    {# Resource Name remains required #}
                    <input type="text" id="resource_name" name="resource_name" required placeholder="Enter a clear title for the resource" value="{{ form_data.get('resource_name', '') }}">
                </div>

                <div class="form-group">
                    <label for="year_start">Year Range:</label>
                    <div class="year-range-selector">
                        <label for="year_start">From:</label>
                        {# Remove required from year_start #}
                        <select id="year_start" name="year_start" class="year-select">
                            <option value="">N/A</option> {# Add an option for not applicable #}
                            {% set current_year = 2025 %} {# Or get dynamically #}
                            {% for year in range(1990, current_year + 1) | reverse %}
                                <option value="{{ year }}" {% if year == form_data.get('year_start', '')|int %}selected{% endif %}>{{ year }}</option>
                            {% endfor %}
                        </select>
                        <label for="year_end">To:</label>
                         {# Remove required from year_end #}
                        <select id="year_end" name="year_end" class="year-select">
                             <option value="">N/A</option> {# Add an option for not applicable #}
                             {% for year in range(1990, current_year + 1) | reverse %}
                                <option value="{{ year }}" {% if year == form_data.get('year_end', '')|int %}selected{% endif %}>{{ year }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="resource_url">Resource URL:</label>
                    {# Remove required from resource_url #}
                    <input type="url" id="resource_url" name="resource_url" placeholder="https://example.com/resource" value="{{ form_data.get('resource_url', '') }}">
                </div>

                <div class="form-group">
                    <label for="contact_info">Contact Information:</label>
                    {# Already optional #}
                    <input type="text" id="contact_info" name="contact_info" placeholder="Name, Email, or Website" value="{{ form_data.get('contact_info', '') }}">
                </div>

                <div class="form-group">
                    <label for="description">Description:</label>
                    {# Remove required from description #}
                    <textarea id="description" name="description" placeholder="Provide a brief description of the resource...">{{ form_data.get('description', '') }}</textarea>
                </div>

                 <div class="form-group">
                    <label for="keywords">Keywords:</label>
                    {# Already optional #}
                    <input type="text" id="keyword-input" placeholder="Type keywords separated by commas" value="{{ form_data.get('keywords', '') }}">
                    <input type="hidden" id="keywords" name="keywords"> <!-- Hidden field to store final comma-separated list -->
                    <div id="selected-keywords" class="selected-items"></div>
                 </div>

                 <div class="form-group">
                    <label for="license">License (Optional):</label>
                    {# Already optional #}
                    <input type="text" id="license" name="license" placeholder="e.g., CC BY 4.0, MIT, Public Domain" value="{{ form_data.get('license', '') }}">
                 </div>

            </fieldset>

            <!-- Related Metadata -->
            <fieldset>
                <legend>Related Metadata Categories (Optional)</legend>
                <p>Select any other relevant categories/items from the hierarchy that relate to this resource.</p>
                <div class="form-group">
                    <div id="related-metadata-tree" class="related-metadata-container">
                        <!-- Hierarchy checkboxes will be populated by JavaScript -->
                        Loading hierarchy...
                    </div>
                    <!-- Hidden input to store selected related metadata paths/IDs as JSON -->
                    <input type="hidden" id="related_metadata" name="related_metadata" value="[]">
                </div>
            </fieldset>

            <!-- Link Existing Resources -->
            <fieldset>
                <legend>Link to Existing Resources (Optional)</legend>
                <p>Search for and select existing resources in the database that are related to this submission.</p>
                <div class="form-group">
                    <label for="related-resources-select">Search and Select Resources:</label>
                    <select id="related-resources-select" class="related-resources-select" multiple="multiple" style="width: 100%;">
                        <!-- Options will be loaded via AJAX by Select2 -->
                    </select>
                    <!-- Hidden input to store selected resource IDs as JSON -->
                    <input type="hidden" id="related_resources" name="related_resources" value="[]">
                </div>
            </fieldset>

            <button type="submit" class="submit-button">Submit for Review</button>
        </form>
    </div>

    <!-- Add jQuery and Select2 JS -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
    // Store hierarchy data globally after fetching
    let resourceHierarchy = {};
    let allHierarchyNodes = []; // Flat list for related metadata selection

    // Function to format display name
    function formatDisplayName(key, details) {
        // If details is null/undefined (e.g., for simple string items), format the key itself
        if (!details) {
            return key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }
        // Otherwise, use title or format the key
        return details?.title || key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    }

    // Function to recursively build the flat list and the checkbox tree
    function buildRelatedMetadataOptions(levelData, parentPath = '', level = 1, container) {
        if (level > 5) return;

        for (const key in levelData) {
            if (key === 'level' || key === 'title') continue; // Skip metadata keys

            const details = levelData[key];
            if (typeof details !== 'object' || details === null) continue; // Skip non-object details

            const displayName = formatDisplayName(key, details);
            const currentPath = parentPath ? `${parentPath} > ${displayName}` : displayName;
            const nodeId = `related_${level}_${key}`; // Unique ID for checkbox

            // Add to flat list for potential future use (e.g., searchable dropdown)
            allHierarchyNodes.push({ id: nodeId, text: currentPath, level: level, key: key });

            // Create checkbox element for the tree view
            const nodeDiv = document.createElement('div');
            nodeDiv.className = 'hierarchy-node';
            nodeDiv.style.setProperty('--level', level); // For CSS indentation

            const label = document.createElement('label');
            label.setAttribute('for', nodeId);

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = nodeId;
            checkbox.value = currentPath; // Store the full path as value
            checkbox.dataset.key = key;
            checkbox.dataset.level = level;

            label.appendChild(checkbox);
            label.appendChild(document.createTextNode(` ${displayName}`)); // Add space
            nodeDiv.appendChild(label);
            container.appendChild(nodeDiv);

            // Recurse for sub_categories
            if (details.sub_categories && typeof details.sub_categories === 'object') {
                buildRelatedMetadataOptions(details.sub_categories, currentPath, level + 1, container);
            }

            // Recurse for items (treat as level + 1)
            if (details.items && Array.isArray(details.items)) {
                const itemLevel = level + 1;
                if (itemLevel <= 5) {
                    details.items.forEach(item => {
                        let itemName = '';
                        let itemKey = '';
                        let itemDetails = {};
                        if (typeof item === 'string') {
                            itemName = item.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                            itemKey = item;
                        } else if (typeof item === 'object' && item !== null && item.name) {
                            itemName = item.title || item.name.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                            itemKey = item.name;
                            itemDetails = item;
                        }

                        if (itemName) {
                            const itemPath = `${currentPath} > ${itemName}`;
                            const itemId = `related_${itemLevel}_${itemKey}`;

                            allHierarchyNodes.push({ id: itemId, text: itemPath, level: itemLevel, key: itemKey });

                            const itemNodeDiv = document.createElement('div');
                            itemNodeDiv.className = 'hierarchy-node';
                            itemNodeDiv.style.setProperty('--level', itemLevel);

                            const itemLabel = document.createElement('label');
                            itemLabel.setAttribute('for', itemId);

                            const itemCheckbox = document.createElement('input');
                            itemCheckbox.type = 'checkbox';
                            itemCheckbox.id = itemId;
                            itemCheckbox.value = itemPath;
                            itemCheckbox.dataset.key = itemKey;
                            itemCheckbox.dataset.level = itemLevel;

                            itemLabel.appendChild(itemCheckbox);
                            itemLabel.appendChild(document.createTextNode(` ${itemName}`));
                            itemNodeDiv.appendChild(itemLabel);
                            container.appendChild(itemNodeDiv);
                        }
                    });
                }
            }
        }
    }


    // Function to populate dependent dropdowns
    function populateHierarchyDropdown(level, parentKey = null) {
        const selectElement = document.getElementById(`level${level}_${level === 1 ? 'resource_type' : level === 2 ? 'category' : level === 3 ? 'subcategory' : level === 4 ? 'data_type' : 'item'}`);
        if (!selectElement) return;

        // Clear subsequent levels first
        for (let i = level + 1; i <= 5; i++) {
            const nextSelect = document.getElementById(`level${i}_${i === 2 ? 'category' : i === 3 ? 'subcategory' : i === 4 ? 'data_type' : 'item'}`);
            if (nextSelect) {
                nextSelect.innerHTML = `<option value="" disabled selected>-- Select ${i === 2 ? 'Category' : i === 3 ? 'Subcategory' : i === 4 ? 'Data Type/Item' : 'Item/Detail'} --</option>`;
                nextSelect.classList.remove('visible');
                // Also reset its value if cleared
                nextSelect.value = "";
            }
        }

        // Find the data for the current level based on parent selection
        let currentLevelData = {}; // Initialize as empty object

        if (level === 1) {
            currentLevelData = resourceHierarchy;
        } else {
            // Get selected values from previous levels
            const selectedValues = [];
            for (let i = 1; i < level; i++) {
                const parentSelect = document.getElementById(`level${i}_${i === 1 ? 'resource_type' : i === 2 ? 'category' : i === 3 ? 'subcategory' : 'data_type'}`);
                // Ensure a value was selected before pushing
                if (parentSelect && parentSelect.value) {
                    selectedValues.push(parentSelect.value);
                } else {
                    // If a previous level is not selected, we can't populate this level
                    selectedValues.length = 0; // Clear the path
                    break;
                }
            }

            // Traverse the hierarchy based on the collected path
            let currentPointer = resourceHierarchy;
            if (selectedValues.length === level - 1) { // Only proceed if the full path is available
                for(let i = 0; i < selectedValues.length; i++) {
                    const key = selectedValues[i];
                    if (!currentPointer || !currentPointer[key]) {
                        currentPointer = null; // Path broken
                        break;
                    }
                    // If this is the last selected value (parent of the level we want to populate)
                    if (i === selectedValues.length - 1) {
                        // Check if it has sub_categories for the target level
                        if (currentPointer[key].sub_categories) {
                            currentLevelData = currentPointer[key].sub_categories;
                        }
                        // Check if it has items for the target level
                        else if (currentPointer[key].items) {
                            currentLevelData = currentPointer[key].items; // Assign the items array
                        }
                        // If neither, currentLevelData remains {}
                    } else {
                        // If not the last step, move deeper into sub_categories
                        if (currentPointer[key].sub_categories) {
                            currentPointer = currentPointer[key].sub_categories;
                        } else {
                            // Cannot go deeper if no sub_categories exist at intermediate step
                            currentPointer = null;
                            break;
                        }
                    }
                }
            }
        }


        // Populate the current dropdown
        selectElement.innerHTML = `<option value="" disabled selected>-- Select ${level === 1 ? 'Resource Type' : level === 2 ? 'Category' : level === 3 ? 'Subcategory' : level === 4 ? 'Data Type/Item' : 'Item/Detail'} --</option>`;

        let hasOptions = false;
        // Handle 'items' array (typically for Level 5, but could be earlier)
        if (Array.isArray(currentLevelData)) {
             currentLevelData.forEach(item => {
                 let itemName = '';
                 let itemKey = '';
                 let itemDetails = {}; // Store potential extra info from item object
                 if (typeof item === 'string') {
                     // Use the string itself as key and format for display name
                     itemKey = item;
                     itemName = formatDisplayName(item, null); // Pass null for details
                 } else if (typeof item === 'object' && item !== null && item.name) {
                     // Use name as key and title/formatted name for display
                     itemKey = item.name;
                     itemDetails = item; // Keep the whole dict
                     itemName = formatDisplayName(itemKey, itemDetails);
                 }

                 if (itemName) { // Ensure we got a valid name/key
                     const option = document.createElement('option');
                     option.value = itemKey;
                     option.textContent = itemName;
                     // Add data attributes from itemDetails if needed later
                     // Object.keys(itemDetails).forEach(detailKey => {
                     //     if (detailKey !== 'name' && detailKey !== 'title') { // Avoid redundancy
                     //         option.dataset[detailKey] = itemDetails[detailKey];
                     //     }
                     // });
                     selectElement.appendChild(option);
                     hasOptions = true;
                 }
             });
        // Handle 'sub_categories' object (typically for Levels 2, 3, 4)
        } else if (typeof currentLevelData === 'object' && Object.keys(currentLevelData).length > 0) {
            for (const key in currentLevelData) {
                // Skip metadata keys like 'level', 'title' if they are siblings to actual categories
                if (key === 'level' || key === 'title') continue;

                const details = currentLevelData[key];
                // Ensure the value is an object (representing a category/item with potential children or metadata)
                 if (typeof details !== 'object' || details === null) continue;

                const displayName = formatDisplayName(key, details);
                const option = document.createElement('option');
                option.value = key;
                option.textContent = displayName;
                selectElement.appendChild(option);
                hasOptions = true;
            }
        }

        // Show dropdown only if it has options
        if (hasOptions) {
            selectElement.classList.add('visible');
        } else {
            selectElement.classList.remove('visible');
        }
    }

    // --- Document Ready ---
    $(document).ready(function() {
        // Initialize Select2 for multi-selects
        $('.multi-select-tags').select2({
            placeholder: "Select one or more...",
            allowClear: true,
            tags: false // Prevent creation of new tags if needed
        });

        // --- Initialize Select2 for Related Resources (AJAX) ---
        $('#related-resources-select').select2({
            placeholder: 'Search by name or ID...',
            minimumInputLength: 2, // Start searching after 2 characters
            allowClear: true,
            ajax: {
                url: '/api/search-resources', // <<< UPDATED: Point to the new search endpoint
                dataType: 'json',
                delay: 250, // Wait 250ms after typing stops
                data: function (params) {
                    return {
                        q: params.term // Search term parameter (named 'q' by default)
                    };
                },
                processResults: function (data) {
                    // Transform the data into the format Select2 expects ({ id: '', text: '' })
                    // This mapping should already be correct based on the new API endpoint's response
                    return {
                        results: data // The API now returns data in the correct {id, text} format
                    };
                },
                cache: true
            }
        });

        // --- Update hidden field when related resources selection changes ---
        $('#related-resources-select').on('change', function() {
            const selectedIds = $(this).val() || []; // Get array of selected IDs
            $('#related_resources').val(JSON.stringify(selectedIds)); // Store as JSON string
        });

        // --- Pre-fill related resources if form is re-rendered ---
        // (This part is more crucial for edit_data.html, but keep the structure)
        try {
            // Get initial IDs from the hidden input (which might hold values if form submission failed)
            const initialRelatedIdsJson = $('#related_resources').val();
            const initialRelatedIds = JSON.parse(initialRelatedIdsJson || '[]');

            if (Array.isArray(initialRelatedIds) && initialRelatedIds.length > 0) {
                // Fetch details for these specific IDs to populate the select field initially
                const fetchPromises = initialRelatedIds.map(id =>
                    fetch(`/api/resource/${id}`) // Use existing endpoint to get details by data_source_id
                        .then(res => res.ok ? res.json() : Promise.reject(`Failed to fetch ${id}`))
                        .catch(error => { console.error(`Error fetching resource ${id}:`, error); return null; })
                );

                Promise.all(fetchPromises)
                    .then(resources => {
                        resources.forEach(resource => {
                            if (resource) {
                                const resourceId = resource.data_source_id;
                                const resourceTitle = resource.metadata?.title || resourceId;
                                const resourceText = `${resourceTitle} (${resourceId})`;
                                // Create a new option element if it doesn't exist
                                if ($('#related-resources-select').find("option[value='" + resourceId + "']").length === 0) {
                                    var newOption = new Option(resourceText, resourceId, true, true);
                                    $('#related-resources-select').append(newOption);
                                }
                            }
                        });
                        $('#related-resources-select').trigger('change'); // Notify Select2 of changes
                    });
            }
        } catch (e) {
            console.error("Error parsing or pre-filling initial related resources:", e);
            $('#related_resources').val('[]'); // Reset hidden field on error
        }
        // --- End Pre-fill ---


        // Fetch hierarchy data
        fetch('/api/resource-hierarchy')
            .then(response => response.ok ? response.json() : Promise.reject('Failed to load hierarchy'))
            .then(hierarchy => {
                resourceHierarchy = hierarchy;

                // --- Restore previous selections and populate dependent dropdowns ---
                function restoreAndPopulate(level) {
                    const selectId = `level${level}_${level === 1 ? 'resource_type' : level === 2 ? 'category' : level === 3 ? 'subcategory' : level === 4 ? 'data_type' : 'item'}`;
                    const selectElement = $(`#${selectId}`);
                    const initialValue = selectElement.data('initial-value'); // Get value stored from server-side rendering

                    if (initialValue) {
                        // Populate the *current* level's dropdown first based on its parent's selection
                        if (level > 1) {
                            populateHierarchyDropdown(level);
                        }
                        // Set the value for the current dropdown
                        selectElement.val(initialValue);
                        // Trigger population for the *next* level if this level has a value and is not the last level
                        if (level < 5) {
                            restoreAndPopulate(level + 1);
                        }
                    } else {
                         // If no initial value for this level, ensure it's populated based on parent (if parent has value)
                         // but don't proceed further down the chain.
                         if (level > 1) {
                             const parentSelectId = `level${level-1}_${level-1 === 1 ? 'resource_type' : level-1 === 2 ? 'category' : level-1 === 3 ? 'subcategory' : 'data_type'}`;
                             if ($(`#${parentSelectId}`).val()) {
                                 populateHierarchyDropdown(level);
                             }
                         }
                    }
                }

                // Store initial values from Flask form_data into data attributes for JS access
                $('.hierarchy-select').each(function() {
                    const level = $(this).data('level');
                    let initialValue = '';
                    if (level === 1) initialValue = "{{ form_data.get('level1_resource_type', '') }}";
                    else if (level === 2) initialValue = "{{ form_data.get('level2_category', '') }}";
                    else if (level === 3) initialValue = "{{ form_data.get('level3_subcategory', '') }}";
                    else if (level === 4) initialValue = "{{ form_data.get('level4_data_type', '') }}";
                    else if (level === 5) initialValue = "{{ form_data.get('level5_item', '') }}";
                    $(this).data('initial-value', initialValue);
                });

                // Start the population/restoration process from Level 1
                restoreAndPopulate(1);
                // --- End Restoration Logic ---


                // Setup change listeners for hierarchy dropdowns
                $('.hierarchy-select').on('change', function() {
                    const currentLevel = parseInt($(this).data('level'));
                    // When a dropdown changes, populate the *next* level
                    if (currentLevel < 5) {
                        populateHierarchyDropdown(currentLevel + 1);
                    }
                });

                // Populate related metadata checkboxes
                const relatedContainer = document.getElementById('related-metadata-tree');
                relatedContainer.innerHTML = ''; // Clear loading message
                buildRelatedMetadataOptions(resourceHierarchy, '', 1, relatedContainer);

                // Add listener to update hidden related_metadata field
                $('#related-metadata-tree').on('change', 'input[type="checkbox"]', function() {
                    const selectedPaths = [];
                    $('#related-metadata-tree input[type="checkbox"]:checked').each(function() {
                        selectedPaths.push($(this).val()); // Store the full path
                    });
                    $('#related_metadata').val(JSON.stringify(selectedPaths));
                });

            })
            .catch(error => {
                console.error('Error fetching resource hierarchy:', error);
                $('#related-metadata-tree').text('Error loading hierarchy.');
                // Optionally disable hierarchy selection fields
            });


        // --- Keyword Input Handling ---
        const keywordInput = document.getElementById('keyword-input');
        const selectedKeywordsContainer = document.getElementById('selected-keywords');
        const keywordsHiddenField = document.getElementById('keywords');
        let keywords = new Set(keywordsHiddenField.value ? keywordsHiddenField.value.split(',').map(k => k.trim()).filter(Boolean) : []);

        function renderKeywords() {
            selectedKeywordsContainer.innerHTML = '';
            keywords.forEach(keyword => {
                const tag = document.createElement('div');
                tag.className = 'selected-tag';
                tag.innerHTML = `
                    ${keyword}
                    <span class="remove-tag" data-value="${keyword}">&times;</span>
                `;
                selectedKeywordsContainer.appendChild(tag);
            });
            keywordsHiddenField.value = Array.from(keywords).join(',');
        }

        // Initial render if keywords exist from form_data
        renderKeywords();

        keywordInput.addEventListener('keydown', function(e) {
            if (e.key === ',' || e.key === 'Enter') {
                e.preventDefault();
                const newKeywords = this.value.split(',')
                                        .map(k => k.trim())
                                        .filter(k => k && !keywords.has(k));
                if (newKeywords.length > 0) {
                    newKeywords.forEach(k => keywords.add(k));
                    renderKeywords();
                }
                this.value = ''; // Clear input
            }
        });
         // Handle blur event to add any remaining text as a keyword
        keywordInput.addEventListener('blur', function(e) {
             const keyword = this.value.trim();
             if (keyword && !keywords.has(keyword)) {
                 keywords.add(keyword);
                 renderKeywords();
             }
             this.value = ''; // Clear input
        });


        selectedKeywordsContainer.addEventListener('click', function(e) {
            if (e.target.classList.contains('remove-tag')) {
                const value = e.target.getAttribute('data-value');
                keywords.delete(value);
                renderKeywords();
            }
        });

        // Update hidden field on form submit (just in case)
        $('#add-resource-form').on('submit', function() {
             // Add any final text in the input box before submitting
             const finalKeyword = keywordInput.value.trim();
             if (finalKeyword && !keywords.has(finalKeyword)) {
                 keywords.add(finalKeyword);
             }
            keywordsHiddenField.value = Array.from(keywords).join(',');

            // Ensure the related resources hidden field is up-to-date
            const selectedIds = $('#related-resources-select').val() || [];
            $('#related_resources').val(JSON.stringify(selectedIds));

            // Update related metadata just in case checkboxes were changed without triggering change event
            const selectedPaths = [];
            $('#related-metadata-tree input[type="checkbox"]:checked').each(function() { selectedPaths.push($(this).val()); });
            $('#related_metadata').val(JSON.stringify(selectedPaths));
        });

    });
    </script>
</body>
</html>